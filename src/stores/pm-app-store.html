<dom-module id="pm-app-store">
  <script>
    class PmAppStore extends Polymer.Element {
      static get is() { return 'pm-app-store'; }

      static get properties() {
        return {
          state: {
            type: Object,
            notify: true
          },
          _messages: {
            type: Array,
            value: () => []
          },
          _userId: {
            type: String,
            value: fakeGuid()
          }
        }
      }

      constructor() {
        super();
        this.state = this._getState();
      }

      dispatch(name) {
        const action = this._actions[name];
        if (!action) {
          throw new Error(`action '${name}' is not defined`);
        }
        const args = [].slice.call(arguments, 1);
        action.apply(this, args);
      }

      get _actions() {
        return {
          'MESSAGE_SEND': this._sendMessage
        }
      }

      _getState() {
        return {
          userId: this._userId,
          messages: this._messages
        }
      }

      _sendMessage(payload) {
        this.push('state.messages', {
          userId: this._userId,
          text: payload
        });
      }
    }

    function fakeGuid() {
      return Math.random().toString().replace("0.", "id.");
    }

    window.customElements.define(PmAppStore.is, PmAppStore);
  </script>
</dom-module>